<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: salesforce.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: salesforce.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// @ts-check
/** @module */
const nforce = require('nforce')
const envCreate = require('env-create')
const logger = require('./util/logger')
const {stringify} = require('./util/helper')
/** @class */
class Salesforce {
  /**
 * Create the TrelloPLus class to add more trello functions
 * @param {?string} pathString path to the trello JSON credentials file
 */
  constructor(param) {
    this.credType = (param &amp;&amp; param.type) || Salesforce.CRED_TYPE.PRODUCTION
    const path = (param &amp;&amp; {path: param.path}) || {}

    const result = envCreate.load(path)
    if (result.status === false) {
      const errorMsg = `FATAL ERROR reading credentials. ${stringify(result)}`
      logger.error(errorMsg)
      throw (errorMsg)
    }

    const sfAuth = this.credType === Salesforce.CRED_TYPE.PRODUCTION ?
      JSON.parse(process.env.sfHelperProduction) :
      JSON.parse(process.env.sfHelperDevelopment)

    this.clientId = sfAuth.clientId
    this.clientSecret = sfAuth.clientSecret

    this.authObj = {
      username: sfAuth.username,
      password: sfAuth.password,
      securityToken: sfAuth.securityToken,
    }

  }

  /**
   * 
   * @param {{path,type}} param  
   * @returns{Promise&lt;Salesforce>}
   */
  static async create(param) {
    const instance = new Salesforce(param)
    instance.createConnection()
    await instance.authenticate()
    return instance
  }

  /**
   * @protected
   * @returns nforce Connection object to be used internally
   * @example don't call directly use the create() function instead
   */
  createConnection() {
    // can also have
    // apiVersion: 'v45.0'
    // environment: 'production' //or 'sandbox'
    this.org = nforce.createConnection({
      clientId: this.clientId,
      clientSecret: this.clientSecret,
      redirectUri: 'http://localhost:3000/oauth/callback',
      environment: 'production', // Salesforce.CRED_TYPE.getType(this.credType),
      mode: 'single',
    })
  }

  /**
   * @protected
   * @returns {Promise}
   * @example don't call directly use the create() function instead
   */
  async authenticate() {
    return this.org.authenticate(this.authObj)
  }

  /**
  * Perform a SOQL Query
  * @param {string} queryString - SOQL query string
  * @returns {Promise&lt;{totalSize:number,done:boolean,records:Array&lt;object>}>}
  * @example query('SELECT ID, Name FROM Account LIMIT 10')
  */
  async query(queryString) {
    return await this.org.query({query: queryString})
  }

  /**
 * Update a record
 * @param {{sObjectName:string, recordDataWithId:object}} param 
 * @returns {Promise} 
 */
  async updateRecord(param) {
    const sobject = nforce.createSObject(param.sObjectName, param.recordDataWithId)
    return await this.org.update({sobject})
  }

  /**
   * Insert a new record on the specified sObject 
   * @param {{sObjectName:string, recordData:object}} param  
   * @returns {Promise&lt;{id, success:boolean, errors:Array}>} 
   * @example let account = createRecord('Account',{Name:'new name',Phone:'800-555-1212'})
   */
  async insertRecord(param) {
    const sobject = nforce.createSObject(param.sObjectName, param.recordData)
    return await this.org.insert({sobject})
  }

  /**
   * 
   * @param {{sObjectName:string,recordDataWithId:object}} param 
   */
  async upsertRecord(param) {
    const {recordDataWithId} = param
    let sobject = nforce.createSObject(param.sObjectName)
    const recordId = recordDataWithId.id ? recordDataWithId.id : ''
    sobject.setExternalId('Id', recordId)
    // sobject = Object.assign(sobject, recordDataWithId)
    sobject = {...sobject, ...recordDataWithId}
    return await this.org.upsert({sobject, requestOpts: {method: !recordId ? 'POST' : 'PATCH'}})
  }

  /**
   * Delete the record that has the id
   * @param {{sObjectName:string, recordDataWithId:object}} param 
   */
  async deleteRecord(param) {
    const sobject = nforce.createSObject(param.sObjectName, param.recordDataWithId)
    return await this.org.delete({sobject})
  }


  /**
   * Gets the payment amount, published date and play by play pub amount for the given course id
   * @param {string} courseId 
   * returns {Promise&lt;Object>}
   */
  async getCourseFinanceInfo(courseId) {
    const fields = 'Completion_Payment_Amount__c, Published_Date__c, Play_by_Play_Publication_Amount__c '
    const fromClause = `from Opportunity where Course_ID__c = '${courseId}'`
    const queryString = `Select ${fields} ${fromClause}`
    return this.query(queryString)
  }
}

Salesforce.CRED_TYPE = {
  PRODUCTION: 1,
  DEVELOPMENT: 2,
  properties: {
    1: {type: 'production'},
    2: {type: 'development'},
  },
  getType: (value) => Salesforce.CRED_TYPE.properties[value].type,
}


module.exports = Salesforce
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-salesforce.html">salesforce</a></li></ul><h3>Classes</h3><ul><li><a href="module-salesforce-Salesforce.html">Salesforce</a></li></ul><h3>Global</h3><ul><li><a href="global.html#logger">logger</a></li><li><a href="global.html#salesforce">salesforce</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Mar 17 2019 23:14:30 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
